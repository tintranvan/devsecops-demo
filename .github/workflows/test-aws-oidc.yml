name: Test AWS OIDC
on:
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Worker service name'
        required: true
        type: choice
        options:
          - demo-app
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
permissions:
  id-token: write
  contents: read

jobs:
  test-aws-access:
    name: Test AWS OIDC Authentication
    runs-on: ubuntu-latest
    
    steps:

    - name: Set deployment variables
      run: |
        # Set SERVICE_NAME
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          SERVICE_NAME="${{ github.event.inputs.service_name }}"
        else
          SERVICE_NAME="demo-app"
        fi
        echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
        
        # Set ENVIRONMENT based on branch or manual input
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENVIRONMENT="prod"
        elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
          ENVIRONMENT="stg"
        else
          ENVIRONMENT="dev"
        fi
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
        
        echo "üöÄ Deploying: $SERVICE_NAME to $ENVIRONMENT"
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ env.ENVIRONMENT == 'prod' && secrets.AWS_ROLE_PROD || env.ENVIRONMENT == 'stg' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-DevSecOps-${{ env.ENVIRONMENT }}-${{ env.SERVICE_NAME }}
        aws-region: us-east-1
        
    - name: Test AWS access
      run: |
        echo "üîç Testing AWS access..."
        echo "AWS Account ID: $(aws sts get-caller-identity --query Account --output text)"
        echo "AWS User/Role: $(aws sts get-caller-identity --query Arn --output text)"
        echo "AWS Region: $AWS_DEFAULT_REGION"
        
    - name: Test SQS access
      run: |
        echo "üì§ Testing SQS access..."
        aws sqs list-queues --region us-east-1
        
    - name: Test Security Hub access
      run: |
        echo "üõ°Ô∏è Testing Security Hub access..."
        aws securityhub describe-hub --region us-east-1 || echo "Security Hub not enabled or no access"
