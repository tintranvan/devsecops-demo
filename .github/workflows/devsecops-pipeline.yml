name: DevSecOps Security Pipeline

on:
  # push:
  #   branches: [ main, develop, staging ]
  push:
    branches: [ dev ]
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  # 1. Environment Setup
  setup:
    name: ðŸ”§ Environment Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.vars.outputs.environment }}
      service_name: ${{ steps.vars.outputs.service_name }}
      continue_on_error: ${{ steps.vars.outputs.continue_on_error }}
      target_url: ${{ steps.vars.outputs.target_url }}
    
    steps:
    - name: Set deployment variables
      id: vars
      run: |
        # Set ENVIRONMENT
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENVIRONMENT="prod"
        elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
          ENVIRONMENT="staging"
        else
          ENVIRONMENT="dev"
        fi
        
        # Set SERVICE_NAME
        SERVICE_NAME="demo-app"
        
        # Set continue-on-error based on environment
        if [ "$ENVIRONMENT" = "dev" ]; then
          CONTINUE_ON_ERROR="true"
        else
          CONTINUE_ON_ERROR="false"
        fi
        
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
        echo "continue_on_error=$CONTINUE_ON_ERROR" >> $GITHUB_OUTPUT
        echo "target_url=https://$ENVIRONMENT-service-01.editforreal.com" >> $GITHUB_OUTPUT
        
        echo "ðŸš€ Pipeline Configuration:"
        echo "  Environment: $ENVIRONMENT"
        echo "  Service: $SERVICE_NAME"
        echo "  Continue on Error: $CONTINUE_ON_ERROR"

    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-DevSecOps-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}

  # 2. Pre-Build Security Scans (Parallel)
  sast-security-scan:
    name: ðŸ” SAST/IaC/SCA/SBOM Security Scan
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      sast-outcome: ${{ steps.sast-scan.outcome }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-SAST-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Run SAST/IaC/SCA/SBOM/Policy Check
      id: sast-scan
      run: |
        if [ -f "./scripts/security-SAST-IaC-SCA-SBOM-PolicyasCode-check.sh" ]; then
          chmod +x ./scripts/security-SAST-IaC-SCA-SBOM-PolicyasCode-check.sh
          ./scripts/security-SAST-IaC-SCA-SBOM-PolicyasCode-check.sh "" ${{ env.AWS_REGION }}
        else
          echo "âš ï¸ SAST script not found, skipping..."
        fi
      continue-on-error: true
      
    - name: Check SAST Results
      run: |
        if [ "${{ steps.sast-scan.outcome }}" = "failure" ]; then
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "âš ï¸ SAST FAILED in DEV - Continuing with warnings"
            echo "::warning title=SAST Security Issues::Security vulnerabilities detected in dev environment. Review and fix before promoting to staging."
          else
            echo "ðŸš¨ SAST FAILED in ${{ needs.setup.outputs.environment }} - Pipeline should stop"
            exit 1
          fi
        else
          echo "âœ… SAST passed successfully"
        fi

  dockerfile-security-scan:
    name: ðŸ³ Dockerfile Security Scan
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      dockerfile-outcome: ${{ steps.dockerfile-scan.outcome }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-Dockerfile-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Setup Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Run Dockerfile Security Validation
      id: dockerfile-scan
      run: |
        chmod +x ./scripts/security-inspector-dockerfile-container-validation.sh
        # Use "none" for OIDC like SAST script
        ./scripts/security-inspector-dockerfile-container-validation.sh none ${{ env.AWS_REGION }}
      continue-on-error: true
      
    - name: Check Dockerfile Results
      run: |
        if [ "${{ steps.dockerfile-scan.outcome }}" = "failure" ]; then
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "âš ï¸ DOCKERFILE SCAN FAILED in DEV - Continuing with warnings"
            echo "::warning title=Dockerfile Security Issues::Dockerfile security issues detected in dev environment. Review and fix before promoting to staging."
          else
            echo "ðŸš¨ DOCKERFILE SCAN FAILED in ${{ needs.setup.outputs.environment }} - Pipeline should stop"
            exit 1
          fi
        else
          echo "âœ… Dockerfile scan passed successfully"
        fi

  #3. Build & Package
  build:
    name: ðŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: [setup, sast-security-scan, dockerfile-security-scan]
    #needs: [setup]
    if: always() && (needs.sast-security-scan.result == 'success' || needs.setup.outputs.continue_on_error == 'true') && (needs.dockerfile-security-scan.result == 'success' || needs.setup.outputs.continue_on_error == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-Build-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
      
    - name: Setup Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Build Application
      run: |
        echo "ðŸ—ï¸ Building application for ${{ needs.setup.outputs.service_name }}"
        
        # Check AWS credentials
        echo "ðŸ” Checking AWS credentials..."
        aws sts get-caller-identity
        
        # Get CodeArtifact auth token
        echo "ðŸ” Getting CodeArtifact auth token..."
        CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
          --domain devsecops-domain \
          --domain-owner 647272350116 \
          --region us-east-1 \
          --query authorizationToken \
          --output text)
        
        # Create temporary pip.conf
        echo "ðŸ“ Creating temporary pip.conf..."
        cd application
        cat > pip.conf << EOF
        [global]
        index-url = https://aws:${CODEARTIFACT_AUTH_TOKEN}@devsecops-domain-647272350116.d.codeartifact.us-east-1.amazonaws.com/pypi/python-packages/simple/
        EOF
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build and cache Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./application
        file: ./application/Dockerfile
        build-args: |
          SERVICE_NAME=${{ needs.setup.outputs.service_name }}
        platforms: linux/amd64
        tags: |
          ${{ needs.setup.outputs.service_name }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: true
        push: false
        provenance: true
        sbom: true
        
    - name: Cleanup Build Files
      run: |
        # Cleanup
        rm -f application/pip.conf
        
        # Clear token from memory
        unset CODEARTIFACT_AUTH_TOKEN
        
    - name: Push to ECR
      run: |
        # Configure ECR repository (use existing repo)
        ACCOUNT_ID="647272350116"
        REGION="us-east-1"
        ECR_REPO="${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/devsecops-${{ needs.setup.outputs.environment }}-java-app"
        VERSION="${{ needs.setup.outputs.environment }}-${{ github.run_number }}"
        
        # Login to ECR
        echo "ðŸ” Logging into ECR..."
        aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com
        
        # Tag and push image
        docker tag ${{ needs.setup.outputs.service_name }}:${{ github.sha }} ${ECR_REPO}:${VERSION}
        docker push ${ECR_REPO}:${VERSION}
        
        echo "âœ… Image pushed to ECR: ${ECR_REPO}:${VERSION}"
        
  #4. Post-Build Security Scans (Parallel)
  image-security-scan:
    name: ðŸ”’ Image Security Scan
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: always() && needs.build.result == 'success'
    outputs:
      image-outcome: ${{ steps.image-scan.outcome }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-ImageScan-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
        
    - name: Run Image Security Scanning
      id: image-scan
      run: |
        if [ -f "./scripts/security-imagescaning.sh" ]; then
          chmod +x ./scripts/security-imagescaning.sh
          # Set environment variables that the script expects
          export ENVIRONMENT=${{ needs.setup.outputs.environment }}
          export IMAGE_TAG="${{ needs.setup.outputs.environment }}-${{ github.run_number }}"
          ./scripts/security-imagescaning.sh
        else
          echo "âš ï¸ Image scanning script not found, skipping..."
        fi
      continue-on-error: true
      
    - name: Check Image Scan Results
      run: |
        if [ "${{ steps.image-scan.outcome }}" = "failure" ]; then
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "âš ï¸ IMAGE SCAN FAILED in DEV - Continuing with warnings"
            echo "::warning title=Image Security Issues::Container image security vulnerabilities detected in dev environment. Review and fix before promoting to staging."
          else
            echo "ðŸš¨ IMAGE SCAN FAILED in ${{ needs.setup.outputs.environment }} - Pipeline should stop"
            exit 1
          fi
        else
          echo "âœ… Image scan passed successfully"
        fi

  container-signing:
    name: âœï¸ Container Image Signing
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: always() && needs.build.result == 'success'
    outputs:
      signing-outcome: ${{ steps.container-sign.outcome }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-Signing-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}

        
    - name: Sign Container Image
      id: container-sign
      run: |
        if [ -f "./scripts/security-container-signer.sh" ]; then
          chmod +x ./scripts/security-container-signer.sh
          # Script expects: ./script.sh [image_name] [profile_name] [region]
          IMAGE_NAME="647272350116.dkr.ecr.us-east-1.amazonaws.com/devsecops-${{ needs.setup.outputs.environment }}-java-app:${{ needs.setup.outputs.environment }}-${{ github.run_number }}"
          ./scripts/security-container-signer.sh "$IMAGE_NAME" "devsecops_image_demo_sign" "${{ env.AWS_REGION }}"
        else
          echo "âš ï¸ Container signing script not found, skipping..."
        fi
      continue-on-error: true
      
    - name: Check Container Signing Results
      run: |
        if [ "${{ steps.container-sign.outcome }}" = "failure" ]; then
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "âš ï¸ CONTAINER SIGNING FAILED in DEV - Continuing with warnings"
            echo "::warning title=Container Signing Issues::Container signing failed in dev environment. Review signing configuration before promoting to staging."
          else
            echo "ðŸš¨ CONTAINER SIGNING FAILED in ${{ needs.setup.outputs.environment }} - Pipeline should stop"
            exit 1
          fi
        else
          echo "âœ… Container signing passed successfully"
        fi

  #5. Deploy
  deploy:
    name: ðŸš€ Deploy to ${{ needs.setup.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [setup, build, image-security-scan, container-signing]
    #needs: [setup, build]
    if: always() && needs.build.result == 'success' && (needs.image-security-scan.result == 'success' || needs.setup.outputs.continue_on_error == 'true') && (needs.container-signing.result == 'success' || needs.setup.outputs.continue_on_error == 'true')
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-ImageScan-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
                
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.5.0"
        
    - name: Deploy Application
      id: deploy
      run: |
        echo "ðŸš€ Deploying ${{ needs.setup.outputs.service_name }} to ${{ needs.setup.outputs.environment }}"
        
        # Set deployment variables
        SERVICE_NAME="${{ needs.setup.outputs.service_name }}"
        ENVIRONMENT="${{ needs.setup.outputs.environment }}"
        VERSION="${ENVIRONMENT}-${{ github.run_number }}"
        SERVICE_NAME_FULL="devsecops-$ENVIRONMENT-$SERVICE_NAME"
        CLUSTER_NAME="devsecops-$ENVIRONMENT-cluster"
        
        # Save current task definition for rollback
        echo "ðŸ’¾ Saving current state for rollback..."
        PREVIOUS_TASK_DEF=$(aws ecs describe-services \
            --cluster $CLUSTER_NAME \
            --services $SERVICE_NAME_FULL \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].taskDefinition' \
            --output text 2>/dev/null || echo "")
        
        
        # Continue with deployment...
        # Image already pushed by build job, proceed with deployment
        
        # Deploy with Terraform
        echo "ðŸ—ï¸ Generating Terraform configuration..."
        python3 scripts/generate-service-infra.py application/service.yaml "$ENVIRONMENT" "$VERSION"
        
        echo "ðŸŒ Deploying infrastructure..."
        cd application/infrastructure
        terraform init
        terraform plan -out=tfplan
        terraform apply tfplan
        
        echo "âœ… Deployment completed successfully"
        
    - name: Health Check
      id: healthcheck
      run: |
        echo "ðŸ¥ Starting health check..."
        SERVICE_NAME_FULL="devsecops-${{ needs.setup.outputs.environment }}-${{ needs.setup.outputs.service_name }}"
        CLUSTER_NAME="devsecops-${{ needs.setup.outputs.environment }}-cluster"
        
        # Health check with rollback
        echo "ðŸ¥ Starting health check (5 minutes max)..."
        for i in {1..30}; do  # 5 minutes max (30 * 10s)
            echo "  Health check attempt $i/30..."
            sleep 10
            
            SERVICE_STATUS=$(aws ecs describe-services \
                --cluster $CLUSTER_NAME \
                --services $SERVICE_NAME_FULL \
                --region ${{ env.AWS_REGION }} \
                --query 'services[0].runningCount' \
                --output text)
            
            DESIRED_COUNT=$(aws ecs describe-services \
                --cluster $CLUSTER_NAME \
                --services $SERVICE_NAME_FULL \
                --region ${{ env.AWS_REGION }} \
                --query 'services[0].desiredCount' \
                --output text)

            if [ "$SERVICE_STATUS" -ge "$DESIRED_COUNT" ]; then
                # Check deployment status
                DEPLOYMENT_STATUS=$(aws ecs describe-services \
                    --cluster $CLUSTER_NAME \
                    --services $SERVICE_NAME_FULL \
                    --region ${{ env.AWS_REGION }} \
                    --query 'services[0].deployments[?status==`PRIMARY`].rolloutState' \
                    --output text)
                
                if [ "$DEPLOYMENT_STATUS" = "COMPLETED" ]; then
                    echo "âœ… Health check passed ($SERVICE_STATUS/$DESIRED_COUNT tasks running)"
                    echo "âœ… Deployment completed successfully"
                    echo "health_status=success" >> $GITHUB_OUTPUT
                    break
                else
                    echo "  Deployment status: $DEPLOYMENT_STATUS ($SERVICE_STATUS/$DESIRED_COUNT tasks)"
                fi
            else
                echo "  Status: $SERVICE_STATUS/$DESIRED_COUNT tasks running..."
            fi
            
            # If this is the last attempt, prepare for rollback
            if [ $i -eq 30 ]; then
                echo "âŒ Health check failed after 30 attempts"
                
                if [ ! -z "$PREVIOUS_TASK_DEF" ] && [ "$PREVIOUS_TASK_DEF" != "None" ]; then
                    echo "ðŸ”„ Rolling back to previous task definition..."
                    
                    aws ecs update-service \
                        --cluster $CLUSTER_NAME \
                        --service $SERVICE_NAME_FULL \
                        --task-definition $PREVIOUS_TASK_DEF \
                        --region ${{ env.AWS_REGION }} >/dev/null
                        
                    echo "âœ… Rollback initiated to $PREVIOUS_TASK_DEF"
                fi
                
                echo "health_status=failed" >> $GITHUB_OUTPUT
                exit 1
            fi
        done
        
        # Check service health
        RUNNING_COUNT=$(aws ecs describe-services \
          --cluster $CLUSTER_NAME \
          --services $SERVICE_NAME_FULL \
          --region ${{ env.AWS_REGION }} \
          --query 'services[0].runningCount' \
          --output text)
        
        DESIRED_COUNT=$(aws ecs describe-services \
          --cluster $CLUSTER_NAME \
          --services $SERVICE_NAME_FULL \
          --region ${{ env.AWS_REGION }} \
          --query 'services[0].desiredCount' \
          --output text)
        
        echo "ðŸ“Š Running: $RUNNING_COUNT, Desired: $DESIRED_COUNT"
        
        if [ "$RUNNING_COUNT" -eq "$DESIRED_COUNT" ] && [ "$RUNNING_COUNT" -gt 0 ]; then
          echo "âœ… Health check passed"
          echo "health_status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Health check failed"
          echo "health_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: Rollback on Health Check Failure
      if: failure() && steps.deploy.outputs.previous_task_def != ''
      run: |
        echo "ðŸ”„ Health check failed, rolling back..."
        aws ecs update-service \
          --cluster ${{ steps.deploy.outputs.cluster_name }} \
          --service ${{ steps.deploy.outputs.service_name_full }} \
          --task-definition ${{ steps.deploy.outputs.previous_task_def }} \
          --region ${{ env.AWS_REGION }}
        
        # Wait for rollback to complete
        aws ecs wait services-stable \
          --cluster ${{ steps.deploy.outputs.cluster_name }} \
          --services ${{ steps.deploy.outputs.service_name_full }} \
          --region ${{ env.AWS_REGION }}
        
        echo "âœ… Rollback completed"
        
    - name: Rollback on Failure
      if: failure() && steps.deploy.outputs.previous_task_def != ''
      run: |
        echo "ðŸ”„ Rolling back to previous task definition..."
        aws ecs update-service \
          --cluster ${{ steps.deploy.outputs.cluster_name }} \
          --service ${{ steps.deploy.outputs.service_name_full }} \
          --task-definition ${{ steps.deploy.outputs.previous_task_def }} \
          --region ${{ env.AWS_REGION }}
        echo "âœ… Rollback completed"
        
        # Set deployment variables
        SERVICE_NAME="${{ needs.setup.outputs.service_name }}"
        ENVIRONMENT="${{ needs.setup.outputs.environment }}"
        VERSION="${ENVIRONMENT}-${{ github.run_number }}"
        ECR_REPO="647272350116.dkr.ecr.us-east-1.amazonaws.com/devsecops-${ENVIRONMENT}-java-app"
        
        # Load Docker image from artifact
        # Image already pushed by build job, proceed with deployment
        
        # Deploy with Terraform
        echo "ðŸ—ï¸ Generating Terraform configuration..."
        NEW_IMAGE_TAG="${ENVIRONMENT}-${{ github.run_number }}"
        python3 scripts/generate-service-infra.py application/service.yaml ${ENVIRONMENT} ${NEW_IMAGE_TAG} || echo "âš ï¸ Terraform generator not found"
        
        echo "ðŸŒ Deploying infrastructure..."
        if [ -d "application/infrastructure" ]; then
          cd application/infrastructure
          terraform init -reconfigure
          terraform apply -auto-approve
        fi
        
        echo "âœ… Deployment completed successfully!"
        echo "ðŸ“¦ Image: ${ECR_REPO}:${ENVIRONMENT}-${{ github.run_number }}"

  # 6. Post-Deploy Security
  dast-security-scan:
    name: ðŸ•·ï¸ DAST Security Scan
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always() && needs.deploy.result == 'success'
    outputs:
      dast-outcome: ${{ steps.dast-scan.outcome }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-DAST-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Run DAST Security Scan
      id: dast-scan
      run: |
        chmod +x ./scripts/security-dast.sh
        # Script expects: ./script.sh [target_url]
        ./scripts/security-dast.sh "${{ needs.setup.outputs.target_url }}"
      continue-on-error: true
      
    - name: Check DAST Results
      run: |
        if [ "${{ steps.dast-scan.outcome }}" = "failure" ]; then
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "âš ï¸ DAST SCAN FAILED in DEV - Continuing with warnings"
            echo "::warning title=DAST Security Issues::Dynamic security vulnerabilities detected in dev environment. Review and fix before promoting to staging."
          else
            echo "ðŸš¨ DAST SCAN FAILED in ${{ needs.setup.outputs.environment }} - Pipeline should stop"
            exit 1
          fi
        else
          echo "âœ… DAST scan passed successfully"
        fi
      
    - name: Upload DAST Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dast-reports-${{ needs.setup.outputs.environment }}
        path: |
          security/reports/*.json
          security/reports/*.html
        retention-days: 30

  # Security Summary
  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [setup, sast-security-scan, dockerfile-security-scan, image-security-scan, container-signing, dast-security-scan]
    if: always()
    
    steps:
    - name: Generate Security Summary
      run: |
        echo "# ðŸ›¡ï¸ DevSecOps Security Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Environment: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Service: ${{ needs.setup.outputs.service_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ” Security Scan Results" >> $GITHUB_STEP_SUMMARY
        
        # SAST Results - based on step outcome, not job result
        if [ "${{ needs.sast-security-scan.outputs.sast-outcome }}" = "success" ]; then
          echo "- âœ… **SAST/IaC/SCA/SBOM**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "- âš ï¸ **SAST/IaC/SCA/SBOM**: FAILED (Dev - Warnings Only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš¨ **SAST/IaC/SCA/SBOM**: FAILED (Pipeline Stopped)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Dockerfile Results - based on step outcome
        if [ "${{ needs.dockerfile-security-scan.outputs.dockerfile-outcome }}" = "success" ]; then
          echo "- âœ… **Dockerfile Security**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "- âš ï¸ **Dockerfile Security**: FAILED (Dev - Warnings Only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš¨ **Dockerfile Security**: FAILED (Pipeline Stopped)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        # Image Security Results - based on step outcome
        if [ "${{ needs.image-security-scan.outputs.image-outcome }}" = "success" ]; then
          echo "- âœ… **Image Security**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "- âš ï¸ **Image Security**: FAILED (Dev - Warnings Only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš¨ **Image Security**: FAILED (Pipeline Stopped)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Container Signing Results - based on step outcome
        if [ "${{ needs.container-signing.outputs.signing-outcome }}" = "success" ]; then
          echo "- âœ… **Container Signing**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "- âš ï¸ **Container Signing**: FAILED (Dev - Warnings Only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš¨ **Container Signing**: FAILED (Pipeline Stopped)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # DAST Results - based on step outcome
        if [ "${{ needs.dast-security-scan.outputs.dast-outcome }}" = "success" ]; then
          echo "- âœ… **DAST Security**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "- âš ï¸ **DAST Security**: FAILED (Dev - Warnings Only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš¨ **DAST Security**: FAILED (Pipeline Stopped)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Security Policy" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
          echo "**DEV Environment**: Security issues show as warnings - deployment continues" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Action Required**: Fix all security issues before promoting to staging" >> $GITHUB_STEP_SUMMARY
        else
          echo "**${{ needs.setup.outputs.environment }} Environment**: Security issues block deployment" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš¨ **Zero Tolerance**: All security issues must be resolved" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”— Security Hub Integration" >> $GITHUB_STEP_SUMMARY
        echo "All security findings have been automatically sent to AWS Security Hub via SQS-Lambda pipeline." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View Security Hub Console](https://us-east-1.console.aws.amazon.com/securityhub/)" >> $GITHUB_STEP_SUMMARY
