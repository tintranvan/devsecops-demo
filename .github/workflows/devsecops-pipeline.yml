name: DevSecOps Security Pipeline

on:
  # push:
  #   branches: [ main, develop, staging ]
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  # 1. Environment Setup
  setup:
    name: ðŸ”§ Environment Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.vars.outputs.environment }}
      service_name: ${{ steps.vars.outputs.service_name }}
      continue_on_error: ${{ steps.vars.outputs.continue_on_error }}
    
    steps:
    - name: Set deployment variables
      id: vars
      run: |
        # Set ENVIRONMENT
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENVIRONMENT="prod"
        elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
          ENVIRONMENT="staging"
        else
          ENVIRONMENT="dev"
        fi
        
        # Set SERVICE_NAME
        SERVICE_NAME="demo-app"
        
        # Set continue-on-error based on environment
        if [ "$ENVIRONMENT" = "dev" ]; then
          CONTINUE_ON_ERROR="true"
        else
          CONTINUE_ON_ERROR="false"
        fi
        
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
        echo "continue_on_error=$CONTINUE_ON_ERROR" >> $GITHUB_OUTPUT
        
        echo "ðŸš€ Pipeline Configuration:"
        echo "  Environment: $ENVIRONMENT"
        echo "  Service: $SERVICE_NAME"
        echo "  Continue on Error: $CONTINUE_ON_ERROR"

    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-DevSecOps-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}

  # 2. Pre-Build Security Scans (Parallel)
  sast-security-scan:
    name: ðŸ” SAST/IaC/SCA/SBOM Security Scan
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-SAST-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Run SAST/IaC/SCA/SBOM/Policy Check
      run: |
        if [ -f "./scripts/security-SAST-IaC-SCA-SBOM-PolicyasCode-check.sh" ]; then
          chmod +x ./scripts/security-SAST-IaC-SCA-SBOM-PolicyasCode-check.sh
          ./scripts/security-SAST-IaC-SCA-SBOM-PolicyasCode-check.sh
        else
          echo "âš ï¸ SAST script not found, skipping..."
        fi
      continue-on-error: ${{ needs.setup.outputs.continue_on_error == 'true' }}
      
    - name: Upload SAST Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sast-reports-${{ needs.setup.outputs.environment }}
        path: |
          security/sast/*.json
          security/sast/*.html
        retention-days: 30

  dockerfile-security-scan:
    name: ðŸ³ Dockerfile Security Scan
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-Dockerfile-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Setup Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Run Dockerfile Security Validation
      run: |
        chmod +x ./scripts/security-inspector-dockerfile-container-validation-clean.sh
        ./scripts/security-inspector-dockerfile-container-validation-clean.sh
      continue-on-error: ${{ needs.setup.outputs.continue_on_error == 'true' }}
      
    - name: Upload Dockerfile Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dockerfile-reports-${{ needs.setup.outputs.environment }}
        path: |
          security/inspector/*.json
        retention-days: 30

  # 3. Build & Package
  build:
    name: ðŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: [setup, sast-security-scan, dockerfile-security-scan]
    if: always() && (needs.sast-security-scan.result == 'success' || needs.setup.outputs.continue_on_error == 'true') && (needs.dockerfile-security-scan.result == 'success' || needs.setup.outputs.continue_on_error == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Build Application
      run: |
        echo "ðŸ—ï¸ Building application for ${{ needs.setup.outputs.service_name }}"
        # Add your build commands here
        docker build -t ${{ needs.setup.outputs.service_name }}:${{ github.sha }} ./application/
        
    - name: Save Docker Image
      run: |
        docker save ${{ needs.setup.outputs.service_name }}:${{ github.sha }} > /tmp/app-image.tar
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ needs.setup.outputs.environment }}
        path: /tmp/app-image.tar
        retention-days: 7

  # 4. Post-Build Security Scans (Parallel)
  image-security-scan:
    name: ðŸ”’ Image Security Scan
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-ImageScan-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ needs.setup.outputs.environment }}
        path: /tmp/
        
    - name: Load Docker Image
      run: docker load < /tmp/app-image.tar
        
    - name: Run Image Security Scanning
      run: |
        if [ -f "./scripts/security-imagescaning.sh" ]; then
          chmod +x ./scripts/security-imagescaning.sh
          ./scripts/security-imagescaning.sh ${{ needs.setup.outputs.service_name }}:${{ github.sha }}
        else
          echo "âš ï¸ Image scanning script not found, skipping..."
        fi
      continue-on-error: ${{ needs.setup.outputs.continue_on_error == 'true' }}

  container-signing:
    name: âœï¸ Container Image Signing
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-Signing-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ needs.setup.outputs.environment }}
        path: /tmp/
        
    - name: Load Docker Image
      run: docker load < /tmp/app-image.tar
        
    - name: Sign Container Image
      run: |
        if [ -f "./scripts/security-container-signer.sh" ]; then
          chmod +x ./scripts/security-container-signer.sh
          ./scripts/security-container-signer.sh ${{ needs.setup.outputs.service_name }}:${{ github.sha }}
        else
          echo "âš ï¸ Container signing script not found, skipping..."
        fi
      continue-on-error: ${{ needs.setup.outputs.continue_on_error == 'true' }}

  # 5. Deploy
  deploy:
    name: ðŸš€ Deploy to ${{ needs.setup.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [setup, build, image-security-scan, container-signing]
    if: always() && needs.build.result == 'success' && (needs.image-security-scan.result == 'success' || needs.setup.outputs.continue_on_error == 'true') && (needs.container-signing.result == 'success' || needs.setup.outputs.continue_on_error == 'true')
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-Deploy-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Deploy Application
      run: |
        echo "ðŸš€ Deploying ${{ needs.setup.outputs.service_name }} to ${{ needs.setup.outputs.environment }}"
        # Add your deployment commands here
        echo "Deployment completed successfully!"

  # 6. Post-Deploy Security
  dast-security-scan:
    name: ðŸ•·ï¸ DAST Security Scan
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always() && needs.deploy.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-DAST-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Run DAST Security Scan
      run: |
        chmod +x ./scripts/security-dast.sh
        ./scripts/security-dast.sh https://dev-service-01.editforreal.com
      continue-on-error: ${{ needs.setup.outputs.continue_on_error == 'true' }}
      
    - name: Upload DAST Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dast-reports-${{ needs.setup.outputs.environment }}
        path: |
          security/reports/*.json
          security/reports/*.html
        retention-days: 30

  # Security Summary
  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [setup, sast-security-scan, dockerfile-security-scan, image-security-scan, container-signing, dast-security-scan]
    if: always()
    
    steps:
    - name: Generate Security Summary
      run: |
        echo "# ðŸ›¡ï¸ DevSecOps Security Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Environment: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Service: ${{ needs.setup.outputs.service_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ” Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "- **SAST/IaC/SCA/SBOM**: ${{ needs.sast-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Dockerfile Security**: ${{ needs.dockerfile-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Security**: ${{ needs.image-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Container Signing**: ${{ needs.container-signing.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **DAST Security**: ${{ needs.dast-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”— Security Hub Integration" >> $GITHUB_STEP_SUMMARY
        echo "All security findings have been automatically sent to AWS Security Hub via SQS-Lambda pipeline." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View Security Hub Console](https://us-east-1.console.aws.amazon.com/securityhub/)" >> $GITHUB_STEP_SUMMARY
