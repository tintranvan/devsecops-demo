name: DevSecOps Security Pipeline

on:
  # push:
  #   branches: [ main, develop, staging ]
  push:
    branches: [ dev, refactor ]
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: "647272350116"

jobs:
  # 1. Environment Setup
  setup:
    name: ðŸ”§ Environment Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.vars.outputs.environment }}
      service_name: ${{ steps.vars.outputs.service_name }}
      continue_on_error: ${{ steps.vars.outputs.continue_on_error }}
      target_url: ${{ steps.vars.outputs.target_url }}
    
    steps:
    - name: Set deployment variables
      id: vars
      run: |
        # Set ENVIRONMENT
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENVIRONMENT="prod"
        elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
          ENVIRONMENT="staging"
        else
          ENVIRONMENT="dev"
        fi
        
        # Set SERVICE_NAME
        SERVICE_NAME="demo-app"
        
        # Set continue-on-error based on environment
        if [ "$ENVIRONMENT" = "dev" ]; then
          CONTINUE_ON_ERROR="true"
        else
          CONTINUE_ON_ERROR="false"
        fi
        
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
        echo "continue_on_error=$CONTINUE_ON_ERROR" >> $GITHUB_OUTPUT
        echo "target_url=https://$ENVIRONMENT-service-01.editforreal.com" >> $GITHUB_OUTPUT
        
        echo "ðŸš€ Pipeline Configuration:"
        echo "  Environment: $ENVIRONMENT"
        echo "  Service: $SERVICE_NAME"
        echo "  Continue on Error: $CONTINUE_ON_ERROR"

    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ steps.vars.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || steps.vars.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-DevSecOps-${{ steps.vars.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}

  # 2. Pre-Build Security Scans (Parallel)
  sast-security-scan:
    name: ðŸ” SAST/IaC/SCA/SBOM Security Scan
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      sast-outcome: ${{ steps.sast-scan.outcome }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-SAST-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Run SAST/IaC/SCA/SBOM/Policy Check
      id: sast-scan
      run: |
        if [ -f "./scripts/security-SAST-IaC-SCA-SBOM-PolicyasCode-check.sh" ]; then
          chmod +x ./scripts/security-SAST-IaC-SCA-SBOM-PolicyasCode-check.sh
          ./scripts/security-SAST-IaC-SCA-SBOM-PolicyasCode-check.sh "" ${{ env.AWS_REGION }}
        else
          echo "âš ï¸ SAST script not found, skipping..."
        fi
      continue-on-error: true
      
    - name: Check SAST Results
      run: |
        if [ "${{ steps.sast-scan.outcome }}" = "failure" ]; then
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "âš ï¸ SAST FAILED in DEV - Continuing with warnings"
            echo "::warning title=SAST Security Issues::Security vulnerabilities detected in dev environment. Review and fix before promoting to staging."
          else
            echo "ðŸš¨ SAST FAILED in ${{ needs.setup.outputs.environment }} - Pipeline should stop"
            exit 1
          fi
        else
          echo "âœ… SAST passed successfully"
        fi
    
    - name: Upload SAST Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sast-reports
        path: security/inspector/*.json
        retention-days: 30
        if-no-files-found: ignore

  dockerfile-security-scan:
    name: ðŸ³ Dockerfile Security Scan
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      dockerfile-outcome: ${{ steps.dockerfile-scan.outcome }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-Dockerfile-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Setup Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Run Dockerfile Security Validation
      id: dockerfile-scan
      run: |
        chmod +x ./scripts/security-inspector-dockerfile-container-validation.sh
        # Use "none" for OIDC like SAST script
        ./scripts/security-inspector-dockerfile-container-validation.sh none ${{ env.AWS_REGION }}
      continue-on-error: true
      
    - name: Check Dockerfile Results
      run: |
        if [ "${{ steps.dockerfile-scan.outcome }}" = "failure" ]; then
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "âš ï¸ DOCKERFILE SCAN FAILED in DEV - Continuing with warnings"
            echo "::warning title=Dockerfile Security Issues::Dockerfile security issues detected in dev environment. Review and fix before promoting to staging."
          else
            echo "ðŸš¨ DOCKERFILE SCAN FAILED in ${{ needs.setup.outputs.environment }} - Pipeline should stop"
            exit 1
          fi
        else
          echo "âœ… Dockerfile scan passed successfully"
        fi
    
    - name: Upload Dockerfile Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dockerfile-reports
        path: security/inspector/*.json
        retention-days: 30
        if-no-files-found: ignore

  #3. Build & Package
  build:
    name: ðŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: [setup, sast-security-scan, dockerfile-security-scan]
    #needs: [setup]
    if: always() && (needs.sast-security-scan.result == 'success' || needs.setup.outputs.continue_on_error == 'true') && (needs.dockerfile-security-scan.result == 'success' || needs.setup.outputs.continue_on_error == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-Build-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
      
    - name: Setup Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Build Application
      run: |
        echo "ðŸ—ï¸ Building application for ${{ needs.setup.outputs.service_name }}"
        
        # Check AWS credentials
        echo "ðŸ” Checking AWS credentials..."
        aws sts get-caller-identity
        
        # Get CodeArtifact auth token
        echo "ðŸ” Getting CodeArtifact auth token..."
        CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
          --domain devsecops-domain \
          --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
          --region ${{ env.AWS_REGION }} \
          --query authorizationToken \
          --output text) || {
          echo "âŒ Failed to get CodeArtifact token"
          exit 1
        }
        
        # Mask token in logs
        echo "::add-mask::$CODEARTIFACT_AUTH_TOKEN"
        
        # Create temporary pip.conf
        echo "ðŸ“ Creating temporary pip.conf..."
        cd application
        cat > pip.conf << EOF
        [global]
        index-url = https://aws:${CODEARTIFACT_AUTH_TOKEN}@devsecops-domain-${{ env.AWS_ACCOUNT_ID }}.d.codeartifact.${{ env.AWS_REGION }}.amazonaws.com/pypi/python-packages/simple/
        EOF
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build and cache Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./application
        file: ./application/Dockerfile
        build-args: |
          SERVICE_NAME=${{ needs.setup.outputs.service_name }}
        platforms: linux/amd64
        tags: |
          ${{ needs.setup.outputs.service_name }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: true
        push: false
        
    - name: Cleanup Build Files
      run: |
        # Cleanup pip.conf (contains sensitive token)
        rm -f application/pip.conf
        echo "âœ… Cleaned up temporary build files"
        
    - name: Push to ECR
      run: |
        # Configure ECR repository
        ECR_REPO="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/devsecops-${{ needs.setup.outputs.environment }}-java-app"
        VERSION="${{ needs.setup.outputs.environment }}-${{ github.run_number }}"
        
        # Login to ECR
        echo "ðŸ” Logging into ECR..."
        aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
        
        # Tag and push image
        docker tag ${{ needs.setup.outputs.service_name }}:${{ github.sha }} ${ECR_REPO}:${VERSION}
        docker push ${ECR_REPO}:${VERSION}
        
        echo "âœ… Image pushed to ECR: ${ECR_REPO}:${VERSION}"
        
  #4. Post-Build Security Scans (Parallel)
  image-security-scan:
    name: ðŸ”’ Image Security Scan
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: always() && needs.build.result == 'success'
    outputs:
      image-outcome: ${{ steps.image-scan.outcome }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-ImageScan-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
        
    - name: Run Image Security Scanning
      id: image-scan
      run: |
        if [ -f "./scripts/security-imagescaning.sh" ]; then
          chmod +x ./scripts/security-imagescaning.sh
          # Set environment variables that the script expects
          export ENVIRONMENT=${{ needs.setup.outputs.environment }}
          export IMAGE_TAG="${{ needs.setup.outputs.environment }}-${{ github.run_number }}"
          ./scripts/security-imagescaning.sh
        else
          echo "âš ï¸ Image scanning script not found, skipping..."
        fi
      continue-on-error: true
      
    - name: Check Image Scan Results
      run: |
        if [ "${{ steps.image-scan.outcome }}" = "failure" ]; then
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "âš ï¸ IMAGE SCAN FAILED in DEV - Continuing with warnings"
            echo "::warning title=Image Security Issues::Container image security vulnerabilities detected in dev environment. Review and fix before promoting to staging."
          else
            echo "ðŸš¨ IMAGE SCAN FAILED in ${{ needs.setup.outputs.environment }} - Pipeline should stop"
            exit 1
          fi
        else
          echo "âœ… Image scan passed successfully"
        fi
    
    - name: Upload Image Scan Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: image-scan-reports
        path: |
          security/ecr/*.json
          security/ecr/*.md
        retention-days: 30
        if-no-files-found: ignore

  container-signing:
    name: âœï¸ Container Image Signing
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: always() && needs.build.result == 'success'
    outputs:
      signing-outcome: ${{ steps.container-sign.outcome }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-Signing-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}

        
    - name: Sign Container Image
      id: container-sign
      run: |
        if [ -f "./scripts/security-container-signer.sh" ]; then
          chmod +x ./scripts/security-container-signer.sh
          # Script expects: ./script.sh [image_name] [profile_name] [region]
          IMAGE_NAME="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/devsecops-${{ needs.setup.outputs.environment }}-java-app:${{ needs.setup.outputs.environment }}-${{ github.run_number }}"
          ./scripts/security-container-signer.sh "$IMAGE_NAME" "devsecops_image_demo_sign" "${{ env.AWS_REGION }}"
        else
          echo "âš ï¸ Container signing script not found, skipping..."
        fi
      continue-on-error: true
      
    - name: Check Container Signing Results
      run: |
        if [ "${{ steps.container-sign.outcome }}" = "failure" ]; then
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "âš ï¸ CONTAINER SIGNING FAILED in DEV - Continuing with warnings"
            echo "::warning title=Container Signing Issues::Container signing failed in dev environment. Review signing configuration before promoting to staging."
          else
            echo "ðŸš¨ CONTAINER SIGNING FAILED in ${{ needs.setup.outputs.environment }} - Pipeline should stop"
            exit 1
          fi
        else
          echo "âœ… Container signing passed successfully"
        fi
    
    - name: Upload Signing Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: signing-reports
        path: security/reports/notation-*.json
        retention-days: 30
        if-no-files-found: ignore

  #5. Deploy
  deploy:
    name: ðŸš€ Deploy to ${{ needs.setup.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [setup, build, image-security-scan, container-signing]
    #needs: [setup, build]
    if: always() && needs.build.result == 'success' && (needs.image-security-scan.result == 'success' || needs.setup.outputs.continue_on_error == 'true') && (needs.container-signing.result == 'success' || needs.setup.outputs.continue_on_error == 'true')
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-ImageScan-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
                
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.5.0"
        
    - name: Deploy Application
      id: deploy
      run: |
        echo "ðŸš€ Deploying ${{ needs.setup.outputs.service_name }} to ${{ needs.setup.outputs.environment }}"
        
        # Set deployment variables
        SERVICE_NAME="${{ needs.setup.outputs.service_name }}"
        ENVIRONMENT="${{ needs.setup.outputs.environment }}"
        VERSION="${ENVIRONMENT}-${{ github.run_number }}"
        SERVICE_NAME_FULL="devsecops-$ENVIRONMENT-$SERVICE_NAME"
        CLUSTER_NAME="devsecops-$ENVIRONMENT-cluster"
        
        # Save current task definition for rollback
        echo "ðŸ’¾ Saving current state for rollback..."
        PREVIOUS_TASK_DEF=$(aws ecs describe-services \
            --cluster $CLUSTER_NAME \
            --services $SERVICE_NAME_FULL \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].taskDefinition' \
            --output text 2>/dev/null || echo "")
        
        # Export variables for rollback steps
        echo "previous_task_def=$PREVIOUS_TASK_DEF" >> $GITHUB_OUTPUT
        echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
        echo "service_name_full=$SERVICE_NAME_FULL" >> $GITHUB_OUTPUT
        
        echo "ðŸ“‹ Rollback info saved:"
        echo "  Previous Task Definition: $PREVIOUS_TASK_DEF"
        echo "  Cluster: $CLUSTER_NAME"
        echo "  Service: $SERVICE_NAME_FULL"
        
        # Deploy with Terraform
        echo "ðŸ—ï¸ Generating Terraform configuration..."
        python3 scripts/generate-service-infra.py application/service.yaml "$ENVIRONMENT" "$VERSION"
        
        echo "ðŸŒ Deploying infrastructure with Terraform..."
        cd application/infrastructure
  
        # Initialize Terraform with backend config
        terraform init -reconfigure
        # Plan and apply
        terraform plan -out=tfplan
        terraform apply -auto-approve tfplan
        
        echo "âœ… Deployment completed successfully"
        
    - name: Health Check
      id: healthcheck
      run: |
        echo "ðŸ¥ Starting health check..."
        SERVICE_NAME_FULL="${{ steps.deploy.outputs.service_name_full }}"
        CLUSTER_NAME="${{ steps.deploy.outputs.cluster_name }}"
        PREVIOUS_TASK_DEF="${{ steps.deploy.outputs.previous_task_def }}"
        
        echo "ðŸ“‹ Health check configuration:"
        echo "  Cluster: $CLUSTER_NAME"
        echo "  Service: $SERVICE_NAME_FULL"
        echo "  Previous Task Def: $PREVIOUS_TASK_DEF"
        
        # Health check with inline rollback capability (optimized for demo)
        echo "ðŸ¥ Starting health check (2 minutes max)..."
        for i in {1..30}; do  # 3 minutes max
            echo "  Health check attempt $i/30..."
            sleep 5
            
            SERVICE_STATUS=$(aws ecs describe-services \
                --cluster $CLUSTER_NAME \
                --services $SERVICE_NAME_FULL \
                --region ${{ env.AWS_REGION }} \
                --query 'services[0].runningCount' \
                --output text)
            
            DESIRED_COUNT=$(aws ecs describe-services \
                --cluster $CLUSTER_NAME \
                --services $SERVICE_NAME_FULL \
                --region ${{ env.AWS_REGION }} \
                --query 'services[0].desiredCount' \
                --output text)

            if [ "$SERVICE_STATUS" -ge "$DESIRED_COUNT" ] && [ "$DESIRED_COUNT" -gt 0 ]; then
                # Check deployment status
                DEPLOYMENT_STATUS=$(aws ecs describe-services \
                    --cluster $CLUSTER_NAME \
                    --services $SERVICE_NAME_FULL \
                    --region ${{ env.AWS_REGION }} \
                    --query 'services[0].deployments[?status==`PRIMARY`].rolloutState' \
                    --output text)
                
                if [ "$DEPLOYMENT_STATUS" = "COMPLETED" ]; then
                    echo "âœ… Health check passed ($SERVICE_STATUS/$DESIRED_COUNT tasks running)"
                    echo "âœ… Deployment completed successfully"
                    echo "health_status=success" >> $GITHUB_OUTPUT
                    exit 0
                else
                    echo "  Deployment status: $DEPLOYMENT_STATUS ($SERVICE_STATUS/$DESIRED_COUNT tasks)"
                fi
            else
                echo "  Status: $SERVICE_STATUS/$DESIRED_COUNT tasks running..."
            fi
            
            # If this is the last attempt, trigger rollback
            if [ $i -eq 30 ]; then
                echo "âŒ Health check failed after 30 attempts"
                echo "health_status=failed" >> $GITHUB_OUTPUT
                
                # Trigger rollback if previous task definition exists
                if [ -n "$PREVIOUS_TASK_DEF" ] && [ "$PREVIOUS_TASK_DEF" != "None" ]; then
                    echo "ðŸ”„ Initiating rollback to previous task definition..."
                    
                    aws ecs update-service \
                        --cluster $CLUSTER_NAME \
                        --service $SERVICE_NAME_FULL \
                        --task-definition $PREVIOUS_TASK_DEF \
                        --region ${{ env.AWS_REGION }} >/dev/null
                        
                    echo "âœ… Rollback initiated to $PREVIOUS_TASK_DEF"
                    echo "â³ Waiting for rollback to stabilize..."
                    
                    # Wait for rollback to complete (max 1 minute)
                    for j in {1..12}; do
                        sleep 5
                        ROLLBACK_STATUS=$(aws ecs describe-services \
                            --cluster $CLUSTER_NAME \
                            --services $SERVICE_NAME_FULL \
                            --region ${{ env.AWS_REGION }} \
                            --query 'services[0].runningCount' \
                            --output text)
                        
                        if [ "$ROLLBACK_STATUS" -ge "$DESIRED_COUNT" ]; then
                            echo "âœ… Rollback completed successfully"
                            break
                        fi
                        echo "  Rollback progress: $ROLLBACK_STATUS/$DESIRED_COUNT tasks..."
                    done
                else
                    echo "âš ï¸ No previous task definition available for rollback"
                fi
                
                exit 1
            fi
        done
        
    - name: Rollback on Deployment Failure
      if: failure() && steps.deploy.outputs.previous_task_def != '' && steps.healthcheck.outcome == 'skipped'
      run: |
        echo "ðŸ”„ Deployment failed before health check, initiating rollback..."
        
        CLUSTER_NAME="${{ steps.deploy.outputs.cluster_name }}"
        SERVICE_NAME_FULL="${{ steps.deploy.outputs.service_name_full }}"
        PREVIOUS_TASK_DEF="${{ steps.deploy.outputs.previous_task_def }}"
        
        if [ -n "$PREVIOUS_TASK_DEF" ] && [ "$PREVIOUS_TASK_DEF" != "None" ]; then
          echo "ðŸ”„ Rolling back to: $PREVIOUS_TASK_DEF"
          
          aws ecs update-service \
            --cluster $CLUSTER_NAME \
            --service $SERVICE_NAME_FULL \
            --task-definition $PREVIOUS_TASK_DEF \
            --region ${{ env.AWS_REGION }}
          
          echo "â³ Waiting for rollback to stabilize..."
          aws ecs wait services-stable \
            --cluster $CLUSTER_NAME \
            --services $SERVICE_NAME_FULL \
            --region ${{ env.AWS_REGION }} || echo "âš ï¸ Rollback wait timeout"
          
          echo "âœ… Rollback completed"
        else
          echo "âš ï¸ No previous task definition available for rollback"
        fi

  # 6. Post-Deploy Security
  dast-security-scan:
    name: ðŸ•·ï¸ DAST Security Scan
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always() && needs.deploy.result == 'success'
    outputs:
      dast-outcome: ${{ steps.dast-scan.outcome }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ needs.setup.outputs.environment == 'prod' && secrets.AWS_ROLE_PROD || needs.setup.outputs.environment == 'staging' && secrets.AWS_ROLE_STG || secrets.AWS_ROLE_DEV }}
        role-session-name: GitHubActions-DAST-${{ needs.setup.outputs.environment }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Run DAST Security Scan
      id: dast-scan
      run: |
        chmod +x ./scripts/security-dast.sh
        # Script expects: ./script.sh [target_url]
        ./scripts/security-dast.sh "${{ needs.setup.outputs.target_url }}"
      continue-on-error: true
      
    - name: Check DAST Results
      run: |
        if [ "${{ steps.dast-scan.outcome }}" = "failure" ]; then
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "âš ï¸ DAST SCAN FAILED in DEV - Continuing with warnings"
            echo "::warning title=DAST Security Issues::Dynamic security vulnerabilities detected in dev environment. Review and fix before promoting to staging."
          else
            echo "ðŸš¨ DAST SCAN FAILED in ${{ needs.setup.outputs.environment }} - Pipeline should stop"
            exit 1
          fi
        else
          echo "âœ… DAST scan passed successfully"
        fi
    
    - name: Upload DAST Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dast-reports-${{ needs.setup.outputs.environment }}
        path: |
          security/reports/zap-*.json
          security/reports/zap-*.html
          security/reports/dast-*.json
        retention-days: 30
        if-no-files-found: ignore
      
  # Security Summary
  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [setup, sast-security-scan, dockerfile-security-scan, image-security-scan, container-signing, dast-security-scan]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download All Security Artifacts
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        path: security-artifacts
    
    - name: Organize Security Files
      run: |
        # Create security directories
        mkdir -p security/reports security/ecr security/inspector
        
        echo "ðŸ“¦ Downloaded artifacts:"
        ls -la security-artifacts/ 2>/dev/null || echo "No artifacts downloaded"
        
        # Copy artifacts to expected locations
        if [ -d "security-artifacts/sast-reports" ]; then
          echo "âœ… Copying SAST reports..."
          cp -v security-artifacts/sast-reports/* security/inspector/ 2>/dev/null || echo "âš ï¸ No SAST files"
        else
          echo "âš ï¸ SAST reports not found"
        fi
        
        if [ -d "security-artifacts/dockerfile-reports" ]; then
          echo "âœ… Copying Dockerfile reports..."
          cp -v security-artifacts/dockerfile-reports/* security/inspector/ 2>/dev/null || echo "âš ï¸ No Dockerfile files"
        else
          echo "âš ï¸ Dockerfile reports not found"
        fi
        
        if [ -d "security-artifacts/image-scan-reports" ]; then
          echo "âœ… Copying Image scan reports..."
          cp -v security-artifacts/image-scan-reports/* security/ecr/ 2>/dev/null || echo "âš ï¸ No Image scan files"
        else
          echo "âš ï¸ Image scan reports not found"
        fi
        
        if [ -d "security-artifacts/dast-reports-${{ needs.setup.outputs.environment }}" ]; then
          echo "âœ… Copying DAST reports..."
          cp -v security-artifacts/dast-reports-${{ needs.setup.outputs.environment }}/* security/reports/ 2>/dev/null || echo "âš ï¸ No DAST files"
        else
          echo "âš ï¸ DAST reports not found"
        fi
        
        if [ -d "security-artifacts/signing-reports" ]; then
          echo "âœ… Copying Signing reports..."
          cp -v security-artifacts/signing-reports/* security/reports/ 2>/dev/null || echo "âš ï¸ No Signing files"
        else
          echo "âš ï¸ Signing reports not found"
        fi
        
        echo ""
        echo "ðŸ“ Final security files:"
        echo "Inspector files:"
        ls -lh security/inspector/ 2>/dev/null || echo "  (empty)"
        echo "ECR files:"
        ls -lh security/ecr/ 2>/dev/null || echo "  (empty)"
        echo "Reports files:"
        ls -lh security/reports/*.json 2>/dev/null || echo "  (empty)"
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Generate Detailed Security Report
      env:
        SAST_OUTCOME: ${{ needs.sast-security-scan.outputs.sast-outcome }}
        DOCKERFILE_OUTCOME: ${{ needs.dockerfile-security-scan.outputs.dockerfile-outcome }}
        IMAGE_OUTCOME: ${{ needs.image-security-scan.outputs.image-outcome }}
        SIGNING_OUTCOME: ${{ needs.container-signing.outputs.signing-outcome }}
        DAST_OUTCOME: ${{ needs.dast-security-scan.outputs.dast-outcome }}
      run: |
        # Generate comprehensive security report
        chmod +x scripts/generate-security-report.py
        python3 scripts/generate-security-report.py \
          "${{ needs.setup.outputs.environment }}" \
          "${{ github.run_number }}" \
          "${{ github.sha }}" || echo "âš ï¸ Report generation failed, continuing..."
        
        echo "âœ… Security report generated successfully"
        ls -lh security/reports/*.html 2>/dev/null || echo "No HTML reports found"
    
    - name: Generate Security Summary
      run: |
        echo "# ðŸ›¡ï¸ DevSecOps Security Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Environment: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Service: ${{ needs.setup.outputs.service_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ” Security Scan Results" >> $GITHUB_STEP_SUMMARY
        
        # SAST Results - based on step outcome, not job result
        if [ "${{ needs.sast-security-scan.outputs.sast-outcome }}" = "success" ]; then
          echo "- âœ… **SAST/IaC/SCA/SBOM**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "- âš ï¸ **SAST/IaC/SCA/SBOM**: FAILED (Dev - Warnings Only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš¨ **SAST/IaC/SCA/SBOM**: FAILED (Pipeline Stopped)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Dockerfile Results - based on step outcome
        if [ "${{ needs.dockerfile-security-scan.outputs.dockerfile-outcome }}" = "success" ]; then
          echo "- âœ… **Dockerfile Security**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "- âš ï¸ **Dockerfile Security**: FAILED (Dev - Warnings Only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš¨ **Dockerfile Security**: FAILED (Pipeline Stopped)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        # Image Security Results - based on step outcome
        if [ "${{ needs.image-security-scan.outputs.image-outcome }}" = "success" ]; then
          echo "- âœ… **Image Security**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "- âš ï¸ **Image Security**: FAILED (Dev - Warnings Only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš¨ **Image Security**: FAILED (Pipeline Stopped)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Container Signing Results - based on step outcome
        if [ "${{ needs.container-signing.outputs.signing-outcome }}" = "success" ]; then
          echo "- âœ… **Container Signing**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "- âš ï¸ **Container Signing**: FAILED (Dev - Warnings Only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš¨ **Container Signing**: FAILED (Pipeline Stopped)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # DAST Results - based on step outcome
        if [ "${{ needs.dast-security-scan.outputs.dast-outcome }}" = "success" ]; then
          echo "- âœ… **DAST Security**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
            echo "- âš ï¸ **DAST Security**: FAILED (Dev - Warnings Only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸš¨ **DAST Security**: FAILED (Pipeline Stopped)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Security Policy" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.setup.outputs.environment }}" = "dev" ]; then
          echo "**DEV Environment**: Security issues show as warnings - deployment continues" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Action Required**: Fix all security issues before promoting to staging" >> $GITHUB_STEP_SUMMARY
        else
          echo "**${{ needs.setup.outputs.environment }} Environment**: Security issues block deployment" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš¨ **Zero Tolerance**: All security issues must be resolved" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Detailed Findings Breakdown
        echo "## ðŸ“‹ Detailed Findings Breakdown" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Load summary JSON if exists
        SUMMARY_FILE="security/reports/security-summary-${{ github.run_number }}.json"
        if [ -f "$SUMMARY_FILE" ]; then
          TOTAL=$(jq -r '.total_findings // 0' "$SUMMARY_FILE")
          CRITICAL=$(jq -r '.critical_count // 0' "$SUMMARY_FILE")
          HIGH=$(jq -r '.high_count // 0' "$SUMMARY_FILE")
          MEDIUM=$(jq -r '.medium_count // 0' "$SUMMARY_FILE")
          LOW=$(jq -r '.low_count // 0' "$SUMMARY_FILE")
          
          echo "### ðŸŽ¯ Overall Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | $CRITICAL | $([ $CRITICAL -gt 0 ] && echo 'âš ï¸ Action Required' || echo 'âœ… Clean') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | $HIGH | $([ $HIGH -gt 0 ] && echo 'âš ï¸ Action Required' || echo 'âœ… Clean') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Medium | $MEDIUM | $([ $MEDIUM -gt 0 ] && echo 'â„¹ï¸ Review' || echo 'âœ… Clean') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Low | $LOW | $([ $LOW -gt 0 ] && echo 'â„¹ï¸ Review' || echo 'âœ… Clean') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL** | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Per-scan breakdown
          echo "### ðŸ” Scan-by-Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # SAST/IaC/SCA/SBOM
          SAST_TOTAL=$(jq -r '.scans["SAST/IaC/SCA/SBOM"].total // 0' "$SUMMARY_FILE")
          SAST_STATUS=$(jq -r '.scans["SAST/IaC/SCA/SBOM"].status // "N/A"' "$SUMMARY_FILE")
          echo "**SAST/IaC/SCA/SBOM**: $SAST_TOTAL findings ($SAST_STATUS)" >> $GITHUB_STEP_SUMMARY
          
          # Dockerfile
          DOCKERFILE_TOTAL=$(jq -r '.scans.Dockerfile.total // 0' "$SUMMARY_FILE")
          DOCKERFILE_STATUS=$(jq -r '.scans.Dockerfile.status // "N/A"' "$SUMMARY_FILE")
          echo "**Dockerfile Security**: $DOCKERFILE_TOTAL findings ($DOCKERFILE_STATUS)" >> $GITHUB_STEP_SUMMARY
          
          # Image Security
          IMAGE_TOTAL=$(jq -r '.scans.ImageSecurity.total // 0' "$SUMMARY_FILE")
          IMAGE_STATUS=$(jq -r '.scans.ImageSecurity.status // "N/A"' "$SUMMARY_FILE")
          echo "**Image Security**: $IMAGE_TOTAL findings ($IMAGE_STATUS)" >> $GITHUB_STEP_SUMMARY
          
          # DAST
          DAST_TOTAL=$(jq -r '.scans.DAST.total // 0' "$SUMMARY_FILE")
          DAST_STATUS=$(jq -r '.scans.DAST.status // "N/A"' "$SUMMARY_FILE")
          echo "**DAST**: $DAST_TOTAL findings ($DAST_STATUS)" >> $GITHUB_STEP_SUMMARY
          
          # Container Signing
          SIGNING_STATUS=$(jq -r '.scans.ContainerSigning.status // "N/A"' "$SUMMARY_FILE")
          echo "**Container Signing**: $SIGNING_STATUS" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Detailed report not available" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”— Security Hub Integration" >> $GITHUB_STEP_SUMMARY
        echo "All security findings have been automatically sent to AWS Security Hub via SQS-Lambda pipeline." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View Security Hub Console](https://us-east-1.console.aws.amazon.com/securityhub/)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¥ **Download Reports**: Check workflow artifacts for detailed XML and JSON reports" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports-${{ needs.setup.outputs.environment }}-${{ github.run_number }}
        path: |
          security/reports/*.html
          security/reports/*.json
        retention-days: 90
